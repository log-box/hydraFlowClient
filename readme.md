# Hydra Flow Client

**Hydra Flow Client** ‚Äî —ç—Ç–æ FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å HTML/JS-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è OAuth2/OIDC-—Ñ–ª–æ—É —á–µ—Ä–µ–∑ ORY Hydra. –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤—Ö–æ–¥–∞, —Å–æ–≥–ª–∞—Å–∏—è –∏ –≤—ã—Ö–æ–¥–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ "–Ω–∞ –ª–µ—Ç—É" —á–µ—Ä–µ–∑ UI. –ó–∞–º–µ–Ω—è–µ—Ç Postman –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Hydra –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤.

---

## ‚öôÔ∏è –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

* UI + backend –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ `authorization_code` —Ñ–ª–æ—É –≤ Hydra
* –í–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ª–æ–≥–∏–Ω–∞/–∫–æ–Ω—Å–µ–Ω—Ç–∞ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ HTML-—Ñ–æ—Ä–º—ã
* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (JWT)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—à–∏–±–æ–∫ `error`/`error_description` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–∫–∞–∑–æ–≤
* –í–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–µ redirect-uri –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/                   # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã FastAPI: login, consent, logout, redirect
‚îÇ   ‚îú‚îÄ‚îÄ core/                  # –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Hydra, —Å–µ—Å—Å–∏–∏, payload
‚îÇ   ‚îú‚îÄ‚îÄ static/                # HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã (login.html, consent.html –∏ –¥—Ä.)
‚îÇ   ‚îú‚îÄ‚îÄ templates/             # –®–∞–±–ª–æ–Ω—ã Jinja (–Ω–∞–ø—Ä–∏–º–µ—Ä, redirect_result)
‚îÇ   ‚îú‚îÄ‚îÄ main.py                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ config.py              # –†–∞–±–æ—Ç–∞ —Å .env –∏ in-memory –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ logger.py              # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ schemas.py             # Pydantic-—Å—Ö–µ–º—ã
‚îú‚îÄ‚îÄ hydra/config/hydra.yml     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ORY Hydra
‚îú‚îÄ‚îÄ init/
‚îÇ   ‚îú‚îÄ‚îÄ client.template.json   # –®–∞–±–ª–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ Hydra
‚îÇ   ‚îú‚îÄ‚îÄ generate-client.sh     # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è client.json –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ init-hydra.sh          # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ Hydra
‚îú‚îÄ‚îÄ .env                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–ª—è FastAPI)
‚îú‚îÄ‚îÄ Dockerfile                 # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ docker-compose.yml         # FastAPI + Hydra + Postgres + Init
‚îî‚îÄ‚îÄ readme.md                  # –í—ã –∑–¥–µ—Å—å
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)

```bash
docker-compose up --build
```

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:

* UI –∫–ª–∏–µ–Ω—Ç–∞: [http://localhost:3000](http://localhost:3000)
* Hydra Admin API: [http://localhost:4445](http://localhost:4445)
* Hydra Public API: [http://localhost:4444](http://localhost:4444)

---

## üß† –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (login, consent, subject, claims) —Ö—Ä–∞–Ω–∏—Ç—Å—è **–≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ `config.py`.

* –ü—Ä–∏ –≤—Ö–æ–¥–µ (`/login`) –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–æ—Ä–º—ã
* –ü—Ä–∏ —Å–æ–≥–ª–∞—Å–∏–∏ (`/consent`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å, –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ñ–ª–∞–≥–∏ `remember`, `extend_lifespan`, –∏–∑–º–µ–Ω–∏—Ç—å ID, scope –∏ –¥—Ä.

**–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** ‚Äî Redis, cookie –∏ –ë–î –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è.

---

## üìã –ú–∞—Ä—à—Ä—É—Ç—ã

| URL                              | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| -------------------------------- | ------------------------------------------ |
| `/login?login_challenge=...`     | –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è)                |
| `/consent?consent_challenge=...` | –§–æ—Ä–º–∞ —Å–æ–≥–ª–∞—Å–∏—è                             |
| `/logout?logout_challenge=...`   | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏                          |
| `/redirect-uri`                  | –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ / –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ |
| `/redirect-uri-second`           | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π redirect –¥–ª—è —Ç–µ—Å—Ç–æ–≤         |

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **–æ—Ç–∫–∞–∑–∞ —Å –æ—à–∏–±–∫–æ–π** —á–µ—Ä–µ–∑ –ø–æ–ª—è `error` –∏ `error_description`
* –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (access, ID) –∫–∞–∫ JWT (–≤ UI)

---

## üîß REST API (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ)

–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Ñ—Ä–æ–Ω—Ç–∞:

| –ú–µ—Ç–æ–¥  | –≠–Ω–¥–ø–æ–∏–Ω—Ç            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                        |
| ------ | ------------------- | --------------------------------- |
| `GET`  | `/login_settings`   | –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏–Ω–∞ |
| `POST` | `/login_process`    | –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–æ–≥–∏–Ω / –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è    |
| `GET`  | `/consent_settings` | –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã        |
| `POST` | `/consent_process`  | –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å consent / –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è  |

---

## üìÑ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env`)

–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```env
# Hydra API
HYDRA_URL=http://hydra:4444
HYDRA_PRIVATE_URL=http://hydra:4445
HYDRA_OUTSIDE_URL=http://localhost:4444

# –ö–ª–∏–µ–Ω—Ç
CLIENT_ID=...
CLIENT_SECRET=...
REDIRECT_URI=/redirect-uri
POST_LOGOUT_REDIRECT_URI=/logout

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏–Ω–∞
LOGIN_SUBJECT=...
LOGIN_CREDENTIAL=...
LOGIN_ACR=...
LOGIN_AMR=...
LOGIN_CONTEXT={"DEFAULT":"DEFAULT"}
EXTEND_SESSION_LIFESPAN=true
REMEMBER=true
REMEMBER_FOR=0

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã consent
CONSENT_CONTEXT={"DEFAULT":"DEFAULT"}
GRANT_SCOPE=openid,offline
GRANT_ACCESS_TOKEN_AUDIENCE=MAPIC
SESSION_ID_TOKEN={"login":"DEFAULT"}
SESSION_ACCESS_TOKEN={"identity_id":"DEFAULT"}
```

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ —ç—Ç–∞–ø–µ –ª–æ–≥–∏–Ω–∞ –∏ —Å–æ–≥–ª–∞—Å–∏—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

---

## üõ† –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

* –í –±—É–¥—É—â–µ–º –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ:

  * —Ç–µ—Å—Ç–æ–≤ (`pytest`, `httpx`)
  * Helm-—á–∞—Ä—Ç–∞ –¥–ª—è Kubernetes
  * –º–∏–≥—Ä–∞—Ü–∏–π –∏ seed-–¥–∞–Ω–Ω—ã—Ö
