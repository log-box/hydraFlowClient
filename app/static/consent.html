<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consent challenge stage</title>
  <style>
    :root {
      --bg-gradient: radial-gradient(1200px 600px at 10% -10%, #eef4ff 0%, #ffffff 40%),
        linear-gradient(145deg, #f7f9fc, #ffffff);
      --card-bg: #ffffff;
      --text-color: #1f2a37;
      --muted-color: #6b7280;
      --accent-color: #2563eb;
      --accent-hover: #1e40af;
      --border-color: #e5e7eb;
      --ring: rgba(37, 99, 235, 0.2);
      --code-bg: #0b1220;
      --code-fg: #e5edff;
      --success-bg: #f0fdf4;
      --success-border: #22c55e;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      background: var(--bg-gradient);
      color: var(--text-color);
      line-height: 1.55;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    .wrap { padding: 32px 16px; }

    .container {
      max-width: 840px;
      margin: 0 auto;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.06), transparent);
    }

    .title { margin: 0; font-size: 1.35rem; letter-spacing: .2px; }

    .badge {
      font-size: 12px; color: var(--muted-color); background: #f3f4f6; border: 1px solid var(--border-color);
      padding: 6px 10px; border-radius: 999px;
    }

    .content { padding: 20px 24px 24px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 20px; }
    .full { grid-column: 1 / -1; }

    label { display: block; font-weight: 600; margin-bottom: 6px; }
    .hint { display: block; font-size: 12px; color: var(--muted-color); margin-top: 6px; }

    input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 10px;
      font-size: 0.975rem; transition: box-shadow .15s ease, border-color .15s ease; background: #fff;
    }
    textarea { resize: vertical; }

    input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
      outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--ring);
    }

    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    .check { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px dashed var(--border-color); border-radius: 10px; }

    .button-group { margin-top: 18px; display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 12px; }

    button { padding: 10px 16px; background: var(--accent-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: transform .06s ease, background .15s ease; }
    button:hover { background: var(--accent-hover); }
    button:active { transform: translateY(1px); }
    .btn-ghost { background: #eef2ff; color: #1e3a8a; }
    .btn-ghost:hover { background: #e0e7ff; }

    details { margin-top: 18px; border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
    summary { list-style: none; cursor: pointer; padding: 12px 14px; background: #f8fafc; border-bottom: 1px solid var(--border-color); font-weight: 700; }
    summary::-webkit-details-marker { display: none; }

    details pre { margin: 0; white-space: pre-wrap; word-break: break-word; background: var(--code-bg); color: var(--code-fg); padding: 14px 16px; max-height: 420px; overflow: auto; font-size: 0.88rem; line-height: 1.5; }

    #activeSessionBlock { background: var(--success-bg); border: 1px solid var(--success-border); padding: 14px; border-radius: 14px; margin-top: 20px; overflow-x: auto; }
    #activeSessionBlock h3 { margin: 0 0 8px; }

    .divider { height: 1px; background: var(--border-color); margin: 16px 0; }

    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="container">
      <div class="header">
        <h1 class="title">Согласие и кастомизация токенов (Consent challenge)</h1>
        <span class="badge" id="challengeBadge" title="Текущий consent_challenge">challenge: —</span>
      </div>

      <div class="content">
        <form id="consentForm">
          <div class="grid">
            <div class="full">
              <p class="hint" style="margin:0">Этап согласия в потоке OAuth2/OIDC (Ory Hydra). Здесь вы подтверждаете аудиторию, скопы и добавляете произвольные клеймы в токены.</p>
              <div class="divider"></div>
            </div>

            <div class="full">
              <label for="grant_access_token_audience">Список сервисов, которые будут доверять access token</label>
              <input id="grant_access_token_audience" name="grant_access_token_audience" type="text" placeholder="MAPIC, USSS (через запятую)" />
              <small class="hint">Будет передано в <code>grant_access_token_audience</code>. Введите список через запятую или пробел.</small>
            </div>

            <div class="full">
              <label for="grant_scope">Hydra выдаст Access токен с этими скопами</label>
              <input id="grant_scope" name="grant_scope" type="text" placeholder="openid, offline, profile (через запятую)" />
              <small class="hint">Скопы согласия (<code>grant_scope</code>). Например: <code>openid</code>, <code>profile</code>, <code>offline_access</code>.</small>
            </div>

            <div class="row full">
              <div class="check">
                <input id="remember" name="remember" type="checkbox" />
                <label for="remember" style="font-weight:600;">Сохранить согласие пользователя (consent-сессию)</label>
              </div>
              <div style="flex:1 1 220px; min-width:220px;">
                <label for="remember_for">На сколько сохранить согласие (в секундах, 0 = навсегда)</label>
                <input id="remember_for" name="remember_for" type="number" placeholder="3600" inputmode="numeric" />
                <small class="hint">Если <b>включено</b> «Сохранить согласие», TTL берётся отсюда. <code>0</code> — без ограничения.</small>
              </div>
            </div>

            <div class="full">
              <label for="context">Дополнительные данные (context)</label>
              <textarea id="context" name="context" rows="3" data-json data-json-object onblur="tryFormatJson(this)" placeholder='{"app": "frontend", "env": "dev"}'></textarea>
              <small class="hint">Произвольный JSON-объект, доступный обработчику согласия. Поле валидируется и форматируется.</small>
            </div>

            <div class="full">
              <label for="session.id_token">Кастомные клеймы ID Token</label>
              <textarea id="session.id_token" name="session.id_token" rows="3" data-json data-json-object onblur="tryFormatJson(this)" placeholder='{"login": "user123"}'></textarea>
              <small class="hint">Будут включены в <code>id_token</code> (секция <code>session.id_token</code>). Должен быть JSON-объект.</small>
            </div>

            <div class="full">
              <label for="session.access_token">Кастомные клеймы Access Token</label>
              <textarea id="session.access_token" name="session.access_token" rows="3" data-json data-json-object onblur="tryFormatJson(this)" placeholder='{"identity_id": "abc-123"}'></textarea>
              <small class="hint">Будут включены в <code>access_token</code> (секция <code>session.access_token</code>). Должен быть JSON-объект.</small>
            </div>

            <div class="full">
              <details>
                <summary>Отказ от согласия (ошибка)</summary>
                <div style="padding:12px 14px; background:#fff;">
                  <div class="grid">
                    <div>
                      <label for="error">Error (для отказа)</label>
                      <input id="error" name="error" type="text" placeholder="например, access_denied" />
                      <small class="hint">Код ошибки OAuth2/OIDC (по умолчанию <code>access_denied</code>).</small>
                    </div>
                    <div>
                      <label for="error_description">Error Description</label>
                      <input id="error_description" name="error_description" type="text" placeholder="например, Пользователь отказался" />
                      <small class="hint">Человекочитаемое описание причины отказа.</small>
                    </div>
                  </div>
                </div>
              </details>
            </div>

            <input name="consent_challenge" type="hidden" value="" />
            <input name="session_id" type="hidden" value="" />

            <div class="button-group full">
              <button type="button" class="btn-ghost" onclick="onSubmit(false)">Отмена</button>
              <button type="button" onclick="onSubmit(true)">Далее</button>
            </div>

            <div class="full">
              <details>
                <summary>Детали get consentChallenge (техническое)</summary>
                <pre id="consentRequestJson"></pre>
              </details>

              <div id="activeSessionBlock" style="display:none;">
                <h3>⚡ Значения подгружены из активной сессии</h3>
                <pre id="activeSessionInfoJson"></pre>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ВАЖНО: ниже — исходные скрипты БЕЗ изменений логики/имён полей/функций -->
  <script>
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    async function loadSettings() {
      try {
        const challenge = getQueryParam("consent_challenge");
        const badge = document.getElementById("challengeBadge");
        if (badge) badge.textContent = `challenge: ${challenge || "—"}`;
        if (!challenge) {
          alert("consent_challenge не указан");
          return;
        }
        // Основные настройки
        const form = document.forms.consentForm;
        const settingsRes = await fetch(`/consent_settings?consent_challenge=${challenge}`);
        const settingsData = await settingsRes.json();
        form.elements["session_id"].value = settingsData.session_id;
        if (settingsData.active_session_info) {
          document.getElementById("activeSessionBlock").style.display = "block";
          document.getElementById("activeSessionInfoJson").textContent = JSON.stringify(
            settingsData.active_session_info, null, 2
          );
        }

        // JSON для отображения
        const consentRequestRes = await fetch(`/consent_request_data?session_id=${settingsData.session_id}`);
        const consentRequestData = await consentRequestRes.json();
        document.getElementById("consentRequestJson").textContent = JSON.stringify(consentRequestData, null, 2);

        form.consent_challenge.value = challenge;

        for (const key in settingsData) {
          if (key === "session") {
            if (settingsData.session?.id_token && form['session.id_token']) {
              form['session.id_token'].value = JSON.stringify(settingsData.session.id_token, null, 2);
            }
            if (settingsData.session?.access_token && form['session.access_token']) {
              form['session.access_token'].value = JSON.stringify(settingsData.session.access_token, null, 2);
            }
            continue;
          }

          const el = form.elements[key];
          if (!el) continue;

          if (el.type === 'checkbox') {
            el.checked = Boolean(settingsData[key]);
          } else if (Array.isArray(settingsData[key])) {
            el.value = settingsData[key].join(", ");
          } else if (typeof settingsData[key] === 'object' && settingsData[key] !== null) {
            el.value = JSON.stringify(settingsData[key], null, 2);
          } else {
            el.value = settingsData[key];
          }
        }

        document.querySelectorAll("input[data-json]").forEach(input => {
          input.addEventListener("input", () => {
            const mustBeObject = input.hasAttribute("data-json-object");
            validateJsonField(input, mustBeObject);
          });
        });

      } catch (e) {
        alert('Ошибка загрузки настроек: ' + e.message);
        console.error(e);
      }
    }

    async function onSubmit(continueFlow) {
      const form = document.forms.consentForm;

      if (!validateAllJsonFields()) {
        alert("Проверьте корректность JSON в выделенных полях");
        return;
      }

      if (!continueFlow) {
        return await rejectConsent(form);
      }

      return await acceptConsent(form);
    }

    async function rejectConsent(form) {
      const data = {
        consent_challenge: form.consent_challenge.value,
        continue_: false,
        error: form.error.value || "access_denied",
        error_description: form.error_description.value || "Пользователь отказался предоставить согласие"
      };

      await sendConsentPayload(data);
    }

    async function acceptConsent(form) {
      let context = {}, idToken = {}, accessToken = {};

      try {
        context = parseJsonOrEmpty(form.context.value);
        idToken = parseJsonOrEmpty(form['session.id_token'].value);
        accessToken = parseJsonOrEmpty(form['session.access_token'].value);
      } catch (e) {
        alert("Ошибка парсинга JSON: " + e.message);
        return;
      }

      const data = {
        session_id: form.session_id.value,
        consent_challenge: form.consent_challenge.value,
        context,
        grant_access_token_audience: splitCSV(form.grant_access_token_audience.value),
        grant_scope: splitCSV(form.grant_scope.value),
        remember: form.remember.checked,
        remember_for: parseInt(form.remember_for.value, 10),
        session: {
          id_token: idToken,
          access_token: accessToken
        },
        continue_: true,
        error: null,
        error_description: null
      };

      await sendConsentPayload(data);
    }

    async function sendConsentPayload(data) {
      const res = await fetch('/consent_process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        const result = await res.json();
        if (result.redirect_url) {
          redirectWithHostRewrite(result.redirect_url);
        } else {
          alert('Успешно, но без redirect_url');
        }
      } else {
        const errorText = await res.text();
        alert('Ошибка сервера: ' + errorText);
      }
    }

    function splitCSV(val) {
      return val
        .replace(/\s+/g, ',')
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
    }

    function parseJsonOrEmpty(value) {
      const trimmed = value.trim();
      return trimmed ? JSON.parse(trimmed) : {};
    }

    function validateJsonInput(input) {
      const value = input.value.trim();
      if (!value) return true;
      try {
        const parsed = JSON.parse(value);
        if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
          throw new Error("Ожидается JSON-объект");
        }
        input.style.border = "";
        input.title = "";
        return true;
      } catch (e) {
        input.style.border = "2px solid red";
        input.title = "Ошибка JSON: " + e.message;
        return false;
      }
    }
    function validateJsonField(input, mustBeObject = false) {
      const value = input.value.trim();
      if (!value) {
        input.style.border = "";
        input.title = "";
        return true;
      }
      try {
        const parsed = JSON.parse(value);

        if (mustBeObject && (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed))) {
          throw new Error("Ожидается JSON-объект (не массив)");
        }

        input.style.border = "";
        input.title = "";
        return true;
      } catch (e) {
        input.style.border = "2px solid red";
        input.title = "Ошибка JSON: " + e.message;
        return false;
      }
    }

    function validateAllJsonFields() {
      const jsonInputs = document.querySelectorAll("input[data-json]");
      let allValid = true;

      jsonInputs.forEach(input => {
        const mustBeObject = input.hasAttribute("data-json-object");
        const valid = validateJsonField(input, mustBeObject);
        if (!valid) allValid = false;
      });

      return allValid;
    }
    function redirectWithHostRewrite(originalUrl) {
      const correctedPath = originalUrl.replace("http://localhost:4444/", "");

      const currentHost = window.location.hostname;
      let baseUrl;

      if (currentHost === "192.168.88.5") {
        baseUrl = "http://192.168.88.5:3001/";
      } else if (currentHost === "logbox.myddns.me") {
        baseUrl = "http://logbox.myddns.me:3001/";
      } else {
        baseUrl = "http://localhost:4444/";
      }

      location.href = baseUrl + correctedPath;
    }
    function tryFormatJson(textarea) {
      const value = textarea.value.trim();
      if (!value) return;

      try {
        const parsed = JSON.parse(value);
        if (typeof parsed !== 'object' || parsed === null) return;
        textarea.value = JSON.stringify(parsed, null, 2);
      } catch (_) {
        // не форматируем, если невалидный
      }
    }
    loadSettings();
  </script>
</body>
</html>
