<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Consent challenge stage</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(145deg, #f0f4f8, #ffffff);
      color: #2c3e50;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      background: white;
      border: 1px solid #e0e6ed;
      border-radius: 12px;
      padding: 2rem 1rem;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
      width: 100%;
      max-width: 720px;
      margin-top: 3vh;
    }

    h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    form label {
      display: block;
      margin-top: 1rem;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }

    input[type="checkbox"] {
      margin-right: 0.5rem;
    }

    .button-group {
      margin-top: 2rem;
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    button {
      padding: 0.6rem 1.2rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      background-color: #0056b3;
    }

    summary {
      font-weight: bold;
      cursor: pointer;
      margin-top: 1.5rem;
    }

    details pre {
      margin: 0.5rem 0 0 0;
      white-space: pre-wrap;
      word-break: break-word;
      background: #f0f0f0;
      padding: 1em;
      border-radius: 5px;
      max-height: 400px;
      overflow: auto;
      font-size: 0.85em;
    }

    #activeSessionBlock {
      background: #f5fff5;
      border-left: 4px solid #28a745;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 2em;
    }

    #activeSessionBlock h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Выдача согласия и кастомизация ID и Access токенов</h2>
  <form id="consentForm">
    <label>Список сервисов, которые будут доверять access token
      <input name="grant_access_token_audience" placeholder='MAPIC, USSS (через запятую)' type="text">
    </label>
    <label>Hydra выдаст Access токен с этими скопами
      <input name="grant_scope" placeholder='openid, offline, profile (через запятую)' type="text">
    </label>
    <label><input name="remember" type="checkbox"> Сохранить согласие пользователя (consent-сессию)</label>
    <label>На сколько сохранить согласие (в секундах, 0 = навсегда)
      <input name="remember_for" placeholder='3600' type="number">
    </label>
<label>Дополнительные данные (context)
  <textarea data-json data-json-object name="context"
            placeholder='{"app": "frontend", "env": "dev"}'
            rows="3" onblur="tryFormatJson(this)"></textarea>
</label>

<label>Кастомные клеймы ID Token
  <textarea data-json data-json-object name="session.id_token"
            placeholder='{"login": "user123"}'
            rows="3" onblur="tryFormatJson(this)"></textarea>
</label>

<label>Кастомные клеймы Access Token
  <textarea data-json data-json-object name="session.access_token"
            placeholder='{"identity_id": "abc-123"}'
            rows="3" onblur="tryFormatJson(this)"></textarea>
</label>

    <label>Error (для отказа)
      <input name="error" placeholder="например, access_denied" type="text">
    </label>
    <label>Error Description
      <input name="error_description" placeholder="например, Пользователь отказался" type="text">
    </label>

    <input name="consent_challenge" type="hidden" value="">
    <input name="session_id" type="hidden" value="">

    <div class="button-group">
      <button onclick="onSubmit(false)" type="button">Отмена</button>
      <button onclick="onSubmit(true)" type="button">Далее</button>
    </div>

    <details>
      <summary>Детали get consentChallenge (техническое)</summary>
      <pre id="consentRequestJson"></pre>
    </details>

    <div id="activeSessionBlock" style="display: none;">
      <h3>⚡ Значения подгружены из активной сессии</h3>
      <pre id="activeSessionInfoJson"></pre>
    </div>
  </form>
</div>

<script>
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    async function loadSettings() {
      try {
        const challenge = getQueryParam("consent_challenge");
        if (!challenge) {
          alert("consent_challenge не указан");
          return;
        }
        // Основные настройки
        const form = document.forms.consentForm;
        const settingsRes = await fetch(`/consent_settings?consent_challenge=${challenge}`);
        const settingsData = await settingsRes.json();
        form.elements["session_id"].value = settingsData.session_id;
        if (settingsData.active_session_info) {
          document.getElementById("activeSessionBlock").style.display = "block";
          document.getElementById("activeSessionInfoJson").textContent = JSON.stringify(
            settingsData.active_session_info, null, 2
          );
        }

            // JSON для отображения
        const consentRequestRes = await fetch(`/consent_request_data?session_id=${settingsData.session_id}`);
        const consentRequestData = await consentRequestRes.json();
        document.getElementById("consentRequestJson").textContent = JSON.stringify(consentRequestData, null, 2);

        form.consent_challenge.value = challenge;

        for (const key in settingsData) {
          if (key === "session") {
            if (settingsData.session?.id_token && form['session.id_token']) {
              form['session.id_token'].value = JSON.stringify(settingsData.session.id_token, null, 2);
            }
            if (settingsData.session?.access_token && form['session.access_token']) {
              form['session.access_token'].value = JSON.stringify(settingsData.session.access_token, null, 2);
            }
            continue;
          }

          const el = form.elements[key];
          if (!el) continue;

          if (el.type === 'checkbox') {
            el.checked = Boolean(settingsData[key]);
          } else if (Array.isArray(settingsData[key])) {
            el.value = settingsData[key].join(", ");
          } else if (typeof settingsData[key] === 'object' && settingsData[key] !== null) {
            el.value = JSON.stringify(settingsData[key], null, 2);
          } else {
            el.value = settingsData[key];
          }
        }

        document.querySelectorAll("input[data-json]").forEach(input => {
          input.addEventListener("input", () => {
            const mustBeObject = input.hasAttribute("data-json-object");
            validateJsonField(input, mustBeObject);
          });
        });

      } catch (e) {
        alert('Ошибка загрузки настроек: ' + e.message);
        console.error(e);
      }
    }



    async function onSubmit(continueFlow) {
      const form = document.forms.consentForm;
        if (!validateAllJsonFields()) {
      alert("Проверьте корректность JSON в выделенных полях");
      return;
    }
      if (!continueFlow) {
        const data = {
          consent_challenge: form.consent_challenge.value,
          continue_: false,
          error: form.error.value || "access_denied",
          error_description: form.error_description.value || "Пользователь отказался предоставить согласие"
        };
    }
      let idToken = {}, accessToken = {}, context = {};
      try {
        idToken = form['session.id_token'].value ? JSON.parse(form['session.id_token'].value) : {};
        accessToken = form['session.access_token'].value ? JSON.parse(form['session.access_token'].value) : {};
        context = form.context.value ? JSON.parse(form.context.value) : {};
      } catch (e) {
        alert('Ошибка парсинга JSON: ' + e.message);
        return;
      }

      const data = {
        session_id: form.session_id.value,
        consent_challenge: form.consent_challenge.value,
        context: context,
        grant_access_token_audience: form.grant_access_token_audience.value
          .replace(/\s+/g, ',')
          .split(',')
          .map(s => s.trim())
          .filter(Boolean),
        grant_scope: form.grant_scope.value
          .replace(/\s+/g, ',')               // заменяем пробелы на запятые
          .split(',')                          // разбиваем по запятым
          .map(s => s.trim())                  // убираем лишние пробелы
          .filter(Boolean),                    // убираем пустые строки
        remember: form.remember.checked,
        remember_for: parseInt(form.remember_for.value, 10),
        session: {
          id_token: idToken,
          access_token: accessToken
        },
        continue_: continueFlow,
        error: null,
        error_description: null
      };

      const res = await fetch('/consent_process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        const result = await res.json();
    if (result.redirect_url) {
      redirectWithHostRewrite(result.redirect_url);
    } else {
      alert('Успешно, но без redirect_url');
    }

      } else {
        const errorText = await res.text();
        alert('Ошибка сервера: ' + errorText);
      }

    }
    function validateJsonInput(input) {
      const value = input.value.trim();
      if (!value) return true;
      try {
        const parsed = JSON.parse(value);
        if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
          throw new Error("Ожидается JSON-объект");
        }
        input.style.border = "";
        input.title = "";
        return true;
      } catch (e) {
        input.style.border = "2px solid red";
        input.title = "Ошибка JSON: " + e.message;
        return false;
      }
    }
    function validateJsonField(input, mustBeObject = false) {
      const value = input.value.trim();
      if (!value) {
        input.style.border = "";
        input.title = "";
        return true;
      }
      try {
        const parsed = JSON.parse(value);

        if (mustBeObject && (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed))) {
          throw new Error("Ожидается JSON-объект (не массив)");
        }

        input.style.border = "";
        input.title = "";
        return true;
      } catch (e) {
        input.style.border = "2px solid red";
        input.title = "Ошибка JSON: " + e.message;
        return false;
      }
    }

    function validateAllJsonFields() {
      const jsonInputs = document.querySelectorAll("input[data-json]");
      let allValid = true;

      jsonInputs.forEach(input => {
        const mustBeObject = input.hasAttribute("data-json-object");
        const valid = validateJsonField(input, mustBeObject);
        if (!valid) allValid = false;
      });

      return allValid;
    }
    function redirectWithHostRewrite(originalUrl) {
      const correctedPath = originalUrl.replace("http://localhost:4444/", "");

      const currentHost = window.location.hostname;
      let baseUrl;

      if (currentHost === "192.168.88.5") {
        baseUrl = "http://192.168.88.5:3001/";
      } else if (currentHost === "logbox.myddns.me") {
        baseUrl = "http://logbox.myddns.me:3001/";
      } else {
        baseUrl = "http://localhost:4444/";
      }

      location.href = baseUrl + correctedPath;
    }
function tryFormatJson(textarea) {
  const value = textarea.value.trim();
  if (!value) return;

  try {
    const parsed = JSON.parse(value);
    textarea.value = JSON.stringify(parsed, null, 2);
  } catch (e) {
    // JSON невалидный — оставляем как есть
  }
}
    loadSettings();
</script>
</body>
</html>
