<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Login challenge stage</title>
  <h1>Прохождение аутентификации. Определение наличия логин-сессии у пользователя. Идентификация пользователя</h1>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 40px auto; }
    label { display: block; margin-top: 1em; }
    input[type="text"], input[type="number"] { width: 100%; padding: 8px; }
    .button-group { margin-top: 2em; display: flex; justify-content: flex-end; gap: 1em; }
    button { padding: 10px 20px; }
    summary {
      font-weight: bold;
      cursor: pointer;
    }

    details pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      background: #f0f0f0;
      padding: 1em;
      border-radius: 5px;
      max-height: 400px;
      overflow: auto;
      font-size: 0.85em;
    }

  </style>
</head>
<body>
  <h2>Вход</h2>
  <form id="loginForm">

    <label>Subject
      <input type="text" name="subject">
    </label>
    <label>Credential
      <input type="text" name="credential">
    </label>
    <label>ACR
      <input type="text" name="acr">
    </label>
    <label>AMR
      <input type="text" name="amr">
    </label>
    <label>Context
      <input type="text" name="context">
    </label>
    <label>
      <input type="checkbox" name="extend_session_lifespan"> Extend session lifespan
    </label>
    <label>
      <input type="checkbox" name="remember"> Remember
    </label>
    <label>Remember For (секунды)
      <input type="number" name="remember_for">
    </label>
    <label>Error (для отмены входа)
      <input type="text" name="error" placeholder="например, access_denied">
    </label>
    <label>Error Description
      <input type="text" name="error_description" placeholder="например, Пользователь отменил вход">
    </label>
    <input type="hidden" name="login_challenge" value="">
    <div class="button-group">
      <button type="button" onclick="onSubmit(false)">Отмена</button>
      <button type="button" onclick="onSubmit(true)">Далее</button>
    </div>
    <details style="margin-top: 2em;">
      <summary>Детали get loginChallenge (техническое)</summary>
      <pre id="loginRequestJson"></pre>
    </details>
  </form>

<script>
function getQueryParam(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}



async function loadSettings() {
  try {
    const challenge = getQueryParam("login_challenge");
    if (!challenge) {
      alert("login_challenge не указан");
      return;
    }

    // Основные данные формы
    const settingsRes = await fetch(`/login_settings?login_challenge=${challenge}`);
    const settingsData = await settingsRes.json();

    // JSON login_request (только для отображения)
    const loginRequestRes = await fetch(`/login_request_data`);
    const loginRequestData = await loginRequestRes.json();
    document.getElementById("loginRequestJson").textContent = JSON.stringify(loginRequestData, null, 2);

    const form = document.forms.loginForm;
    form.login_challenge.value = challenge;

    for (const key in settingsData) {
      if (!form.elements[key]) continue;

      const el = form.elements[key];

      if (el.type === 'checkbox') {
        el.checked = Boolean(settingsData[key]);
      } else if (Array.isArray(settingsData[key])) {
        el.value = settingsData[key].join(",");
      } else if (typeof settingsData[key] === 'object' && settingsData[key] !== null) {
        el.value = JSON.stringify(settingsData[key]);
      } else {
        el.value = settingsData[key];
      }
    }
  } catch (e) {
    alert('Ошибка загрузки настроек: ' + e.message);
  }
}



async function loadLoginRequestData() {
  try {
    const res = await fetch('/login_request_data');
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    const pretty = JSON.stringify(data, null, 2);
    document.getElementById("loginRequestJson").textContent = pretty;
  } catch (e) {
    console.warn("Не удалось загрузить login_request_data:", e);
  }
}
async function onSubmit(continueFlow) {
  const form = document.forms.loginForm;
  if (!continueFlow) {
    const data = {
      login_challenge: form.login_challenge.value,
      continue_: false,
      error: form.error.value || "access_denied",
      error_description: form.error_description.value || "Пользователь отменил вход"
    };

    const res = await fetch('/login_process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (res.ok) {
      const result = await res.json();
      if (result.redirect_url) {
        location.href = result.redirect_url;
      } else {
        alert('Отмена выполнена, но redirect_url отсутствует');
      }
    } else {
      const errorText = await res.text();
      alert('Ошибка отмены входа: ' + errorText);
    }

    return;
  }

  let context = {};
  try {
    context = form.context.value ? JSON.parse(form.context.value) : {};
  } catch (e) {
    alert("Поле context должно быть валидным JSON");
    return;
  }

  const data = {
    login_challenge: form.login_challenge.value,
    subject: form.subject.value,
    credential: form.credential.value,
    acr: form.acr.value.trim(),
    amr: form.amr.value.split(",").map(s => s.trim()),
    context: context,
    extend_session_lifespan: form.extend_session_lifespan.checked,
    remember: form.remember.checked,
    remember_for: parseInt(form.remember_for.value, 10),
    continue_: continueFlow,
    error: continueFlow ? null : form.error.value || "access_denied",
    error_description: continueFlow ? null : form.error_description.value || "Пользователь отменил вход"
  };


  try {
    const res = await fetch('/login_process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (res.ok) {
      const result = await res.json();
      if (result.redirect_url) {
        location.href = result.redirect_url;
      } else {
        alert('Успешно, но без redirect_url');
      }
    } else {
      const errorText = await res.text();
      alert('Ошибка сервера: ' + errorText);
    }
  } catch (e) {
    alert('Ошибка отправки формы: ' + e.message);
  }
}

loadSettings();

</script>

</body>
</html>
