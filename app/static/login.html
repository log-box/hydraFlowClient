<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Login challenge stage</title>
    <style>
        :root {
          --bg-gradient: linear-gradient(145deg, #f0f4f8, #ffffff);
          --text-color: #2c3e50;
          --accent-color: #007bff;
          --accent-hover: #0056b3;
          --border-color: #e0e6ed;
          --code-bg: #f0f0f0;
          --success-bg: #f5fff5;
          --success-border: #28a745;
        }

        * {
          box-sizing: border-box;
        }

        html, body {
          margin: 0;
          padding: 0;
          font-family: "Segoe UI", Roboto, sans-serif;
          background: var(--bg-gradient);
          color: var(--text-color);
          min-height: 100vh;
          display: block;
          line-height: 1.5;
        }

        .container {
          max-width: 720px;
          width: 100%;
          margin: 3vh auto;
          background: white;
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 2rem 1.25rem;
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
        }

        h2 {
          font-size: 1.4rem;
          margin-bottom: 1rem;
          text-align: center;
        }

        form label {
          display: block;
          margin-top: 1rem;
          font-weight: 500;
        }

        input[type="text"],
        input[type="number"] {
          width: 100%;
          padding: 0.6rem;
          margin-top: 0.4rem;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-size: 1rem;
        }

        input[type="checkbox"] {
          margin-right: 0.5rem;
        }

        .button-group {
          margin-top: 2rem;
          display: flex;
          flex-wrap: wrap;
          justify-content: flex-end;
          gap: 1rem;
        }

        button {
          padding: 0.6rem 1.2rem;
          background-color: var(--accent-color);
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 1rem;
          transition: background 0.2s;
        }

        button:hover {
          background-color: var(--accent-hover);
        }

        summary {
          font-weight: bold;
          cursor: pointer;
          margin-top: 1.5rem;
        }

        details pre {
          margin-top: 0.5rem;
          white-space: pre-wrap;
          word-break: break-word;
          background: var(--code-bg);
          padding: 1em;
          border-radius: 6px;
          max-height: 400px;
          overflow: auto;
          font-size: 0.85em;
        }

        #activeSessionBlock {
          background: var(--success-bg);
          border-left: 4px solid var(--success-border);
          padding: 1rem;
          border-radius: 8px;
          margin-top: 2em;
          overflow-x: auto;
        }

        #activeSessionBlock h3 {
          margin-top: 0;
        }

        /* Адаптивные правки */
        @media (max-width: 600px) {
          .container {
            padding: 1.5rem 1rem;
            border-radius: 8px;
          }

          h2 {
            font-size: 1.2rem;
          }

          .button-group {
            flex-direction: column;
            align-items: stretch;
          }

          button {
            width: 100%;
          }

          details pre {
            font-size: 0.8rem;
          }
        }
    </style>

</head>
<body>
<div class="container">
    <h2>Вход в систему</h2>
    <form id="loginForm">
        <label>Subject
            <input name="subject" placeholder="user-uuid-1234" type="text">
        </label>
        <label>Credential
            <input name="credential" placeholder="например, +79200631679" type="text">
        </label>
        <label>ACR
            <input name="acr" placeholder="напр. login_password или OTP" type="text">
        </label>
        <label>AMR
            <input name="amr" placeholder="напр. OAUTH2,exchange" type="text">
        </label>
        <label>Context
            <input data-json data-json-object name="context"
                   placeholder='{"app": "frontend", "env": "dev"}'>
        </label>
        <label><input name="extend_session_lifespan" type="checkbox"> Продлить срок сессии</label>
        <label><input name="remember" type="checkbox"> Запомнить пользователя</label>
        <label>Запомнить на (секунды)
            <input name="remember_for" placeholder="3600" type="number">
        </label>
        <label>Error (для отказа)
            <input name="error" placeholder="например, login_required" type="text">
        </label>
        <label>Error Description
            <input name="error_description" placeholder="например, Пользователь отменил вход" type="text">
        </label>
        <input name="login_challenge" type="hidden" value="">
        <input name="session_id" type="hidden" value="">

        <div class="button-group">
            <button onclick="onSubmit(false)" type="button">Отмена</button>
            <button onclick="onSubmit(true)" type="button">Войти</button>
        </div>

        <details>
            <summary>Детали get loginChallenge (техническое)</summary>
            <pre id="loginRequestJson"></pre>
        </details>

        <div id="activeSessionBlock" style="display: none;">
            <h3>⚡ Значения подгружены из активной сессии</h3>
            <pre id="activeSessionInfoJson"></pre>
        </div>
    </form>
</div>

<script>
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }



    async function loadSettings() {
      try {
        const challenge = getQueryParam("login_challenge");
        if (!challenge) {
          alert("login_challenge не указан");
          return;
        }

        // Основные данные формы
        const form = document.forms.loginForm;
        const settingsRes = await fetch(`/login_settings?login_challenge=${challenge}`);
        const settingsData = await settingsRes.json();
        console.log("Получен session_id:", settingsData.session_id);
        form.elements["session_id"].value = settingsData.session_id;
    <!--    form.elements.session_id.value = settingsData.session_id;-->
        // Проверка наличия сессионных данных
        if (settingsData.active_session_info) {
          document.getElementById("activeSessionBlock").style.display = "block";
          document.getElementById("activeSessionInfoJson").textContent = JSON.stringify(
            settingsData.active_session_info, null, 2
          );
        }
        // JSON login_request (только для отображения)
        const loginRequestRes = await fetch(`/login_request_data?session_id=${settingsData.session_id}`);
        const loginRequestData = await loginRequestRes.json();
        document.getElementById("loginRequestJson").textContent = JSON.stringify(loginRequestData, null, 2);


        form.login_challenge.value = challenge;

        for (const key in settingsData) {
          if (!form.elements[key]) continue;

          const el = form.elements[key];

          if (el.type === 'checkbox') {
            el.checked = Boolean(settingsData[key]);
          } else if (Array.isArray(settingsData[key])) {
            el.value = settingsData[key].join(",");
          } else if (typeof settingsData[key] === 'object' && settingsData[key] !== null) {
            el.value = JSON.stringify(settingsData[key]);
          } else {
            el.value = settingsData[key];
          }
        }

            document.querySelectorAll("input[data-json]").forEach(input => {
          input.addEventListener("input", () => {
            const mustBeObject = input.hasAttribute("data-json-object");
            validateJsonField(input, mustBeObject);
          });
        });

      } catch (e) {
        alert('Ошибка загрузки настроек: ' + e.message);
      }
    }

    async function onSubmit(continueFlow) {
      const form = document.forms.loginForm;
      if (!validateAllJsonFields()) {
      alert("Проверьте корректность JSON в выделенных полях");
      return;
    }

      if (!continueFlow) {
        const data = {
          session_id: form.session_id.value,
          login_challenge: form.login_challenge.value,
          continue_: false,
          error: form.error.value || "access_denied",
          error_description: form.error_description.value || "Пользователь отменил вход"
        };

        const res = await fetch('/login_process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          const result = await res.json();
          if (result.redirect_url) {
             redirectToFixedUrl(result.redirect_url);
          } else {
            alert('Отмена выполнена, но redirect_url отсутствует');
          }
        } else {
          const errorText = await res.text();
          alert('Ошибка отмены входа: ' + errorText);
        }

        return;
      }

        let context = {};
        try {
          const raw = form.context.value.trim();
           if (!validateJsonInput(form['context'])) {
          alert("Ошибка: поле context заполнено некорректно.");
          return;
          }

          context = raw ? JSON.parse(raw) : {};
          if (typeof context !== 'object' || Array.isArray(context) || context === null) {
            throw new Error("context must be a JSON object");
          }
        } catch (e) {
          alert('Ошибка в поле "context": ' + e.message);
          return;
        }

      const data = {
        session_id: form.session_id.value,
        login_challenge: form.login_challenge.value,
        subject: form.subject.value,
        credential: form.credential.value,
        acr: form.acr.value.trim(),
        amr: form.amr.value.split(",").map(s => s.trim()),
        context: context,
        extend_session_lifespan: form.extend_session_lifespan.checked,
        remember: form.remember.checked,
        remember_for: parseInt(form.remember_for.value, 10),
        continue_: continueFlow,
        error: continueFlow ? null : form.error.value || "access_denied",
        error_description: continueFlow ? null : form.error_description.value || "Пользователь отменил вход"
      };


      try {
        const res = await fetch('/login_process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          const result = await res.json();
          if (result.redirect_url) {
            redirectToFixedUrl(result.redirect_url);
          } else {
            alert('Успешно, но без redirect_url');
          }
        } else {
          const errorText = await res.text();
          alert('Ошибка сервера: ' + errorText);
        }
      } catch (e) {
        alert('Ошибка отправки формы: ' + e.message);
      }
    }
    function validateJsonInput(input) {
      const value = input.value.trim();
      if (!value) return true;
      try {
        const parsed = JSON.parse(value);
        if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
          throw new Error("Ожидается JSON-объект");
        }
        input.style.border = "";
        input.title = "";
        return true;
      } catch (e) {
        input.style.border = "2px solid red";
        input.title = "Ошибка JSON: " + e.message;
        return false;
      }
    }
    function validateJsonField(input, mustBeObject = false) {
      const value = input.value.trim();
      if (!value) {
        input.style.border = "";
        input.title = "";
        return true;
      }
      try {
        const parsed = JSON.parse(value);

        if (mustBeObject && (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed))) {
          throw new Error("Ожидается JSON-объект (не массив)");
        }

        input.style.border = "";
        input.title = "";
        return true;
      } catch (e) {
        input.style.border = "2px solid red";
        input.title = "Ошибка JSON: " + e.message;
        return false;
      }
    }

    function validateAllJsonFields() {
      const jsonInputs = document.querySelectorAll("input[data-json]");
      let allValid = true;

      jsonInputs.forEach(input => {
        const mustBeObject = input.hasAttribute("data-json-object");
        const valid = validateJsonField(input, mustBeObject);
        if (!valid) allValid = false;
      });

      return allValid;
    }
    function redirectToFixedUrl(rawUrl) {
      const correctedPath = rawUrl.replace("http://localhost:4444/", "");

      const currentHost = window.location.hostname;
      let baseUrl;

      if (currentHost === "192.168.88.5") {
        baseUrl = "http://192.168.88.5:3001/";
      } else if (currentHost === "logbox.myddns.me") {
        baseUrl = "http://logbox.myddns.me:3001/";
      } else {
        baseUrl = "http://localhost:4444/";
      }

      const correctedUrl = baseUrl + correctedPath;
      location.href = correctedUrl;
    }

    loadSettings();

</script>
</body>
</html>
