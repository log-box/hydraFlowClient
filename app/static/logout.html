<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Завершение сессии</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-gradient: radial-gradient(1200px 600px at 10% -10%, #eef4ff 0%, #ffffff 40%),
        linear-gradient(145deg, #f7f9fc, #ffffff);
      --card-bg: #ffffff;
      --text-color: #1f2a37;
      --muted-color: #6b7280;
      --accent-color: #2563eb;
      --accent-hover: #1e40af;
      --border-color: #e5e7eb;
      --ring: rgba(37, 99, 235, 0.2);
      --code-bg: #0b1220;
      --code-fg: #e5edff;
      --success-bg: #f0fdf4;
      --success-border: #22c55e;
      --warn-bg: #fff7ed;
      --warn-border: #f59e0b;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      background: var(--bg-gradient); color: var(--text-color);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    .wrap { padding: 32px 16px; display:flex; justify-content:center; }

    .container {
      width: 100%; max-width: 840px; background: var(--card-bg);
      border: 1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow);
      overflow: hidden;
    }

    .header { display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 20px 24px; border-bottom:1px solid var(--border-color);
      background: linear-gradient(180deg, rgba(37,99,235,.06), transparent);
    }
    .title { margin:0; font-size:1.35rem; letter-spacing:.2px; }
    .badge { font-size:12px; color:var(--muted-color); background:#f3f4f6; border:1px solid var(--border-color); padding:6px 10px; border-radius:999px; }
    .hint { color: var(--muted-color); font-size: 12px; }

    .content { padding: 20px 24px 24px; }

    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .check { display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px dashed var(--border-color); border-radius:12px; background:#fff; }
    .check input[type="checkbox"] { width: 1.1rem; height: 1.1rem; accent-color: var(--accent-color); margin: 0; }

    button {
      margin-top: 12px; padding: 12px 16px; background: var(--accent-color); color:#fff; border:none; border-radius:12px;
      cursor:pointer; font-weight:600; font-size: .95rem; transition: transform .06s ease, background .15s ease; width:100%;
    }
    button:hover { background: var(--accent-hover); }
    button:active { transform: translateY(1px); }

    details { margin-top: 16px; border:1px solid var(--border-color); border-radius:12px; overflow:hidden; }
    summary { padding:12px 14px; background:#f8fafc; border-bottom:1px solid var(--border-color); font-weight:700; cursor:pointer; list-style:none; }
    summary::-webkit-details-marker { display:none; }

    details pre, pre#log {
      margin:0; white-space: pre-wrap; word-break: break-word; background: var(--code-bg); color: var(--code-fg);
      padding: 14px 16px; border-radius: 0 0 12px 12px; max-height: 360px; overflow: auto; font-size: .9rem; line-height:1.5;
    }

    #log { margin-top: 16px; border:1px solid var(--border-color); border-radius:12px; }

    #fallbackMessage {
      width: 100%; max-width: 720px; margin: 24px auto 0; padding: 18px 16px; text-align:center;
      background: var(--warn-bg); border:1px solid var(--warn-border); border-radius: 12px; color:#7c2d12;
    }
    #fallbackMessage p { margin: .5em 0; }

    .hidden { display:none; }

    @media (max-width: 720px) {
      .title { font-size: 1.2rem; }
      button { font-size: .95rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="container" id="mainContent">
      <div class="header">
        <h1 class="title" id="logoutHeader">Завершение сессии</h1>
        <span class="badge" id="challengeBadge" title="logout_challenge">challenge: —</span>
      </div>

      <div class="content">
        <form id="logoutForm">
          <input id="challenge" name="logout_challenge" type="hidden" value="" />
          <input id="subject" name="subject" type="hidden" />
          <input id="clientId" name="client_id" type="hidden" />

          <div class="row" style="gap:12px;">
            <div class="check">
              <input id="revokeClient" type="checkbox" />
              <label for="revokeClient" id="revokeClientLabel">Отозвать токены у витрины</label>
            </div>
            <div class="check">
              <input id="revokeAll" type="checkbox" />
              <label for="revokeAll">Отозвать токены у всех витрин</label>
            </div>
          </div>

          <button id="logoutBtn" type="submit">Выйти</button>

          <details>
            <summary>Детали get logoutChallenge (техническое)</summary>
            <pre id="logoutRequestJson"></pre>
          </details>

          <pre id="log">[Журнал выполнения]\n</pre>
        </form>
      </div>
    </div>
  </div>

  <!-- Fallback при ошибке -->
  <div class="hidden" id="fallbackMessage">
    <h2>Что-то пошло не так</h2>
    <p>Вы попали на эту страницу при попытке выхода из витрины.</p>
    <p>Однако мы не смогли получить технические данные для завершения выхода.</p>
    <p>Возможно, вы попали сюда напрямую или сессия уже завершена.</p>
    <p>Вы можете закрыть эту вкладку или вернуться на сайт вручную.</p>
  </div>

  <!-- Скрипты ниже: логика и идентификаторы оставлены без изменений -->
  <script>
    function log(msg) {
      console.log(msg);
      document.getElementById('log').textContent += msg + '\n';
    }

    async function fetchAndDisplayLogoutRequest(challenge) {
      try {
        const res = await fetch(`/logout_request_data?logout_challenge=${challenge}`);
        const data = await res.json();
        const logoutRequest = data.logout_request_data;

        document.getElementById("logoutRequestJson").textContent = JSON.stringify(logoutRequest, null, 2);
        log("Данные logout_request загружены и отображены.");

        const sid = logoutRequest.sid;
        const subject = logoutRequest.subject;
        const clientId = logoutRequest.client?.client_id;
        const clientName = logoutRequest.client?.client_name || "неизвестная витрина";

        document.getElementById("logoutHeader").textContent = `Завершение сессии — SID: ${sid}`;
        const badge = document.getElementById("challengeBadge");
        if (badge) badge.textContent = `challenge: ${challenge || '—'}`;
        document.getElementById("revokeClientLabel").innerText = `Отозвать токены у витрины: ${clientName}`;
        document.getElementById("subject").value = subject;
        document.getElementById("clientId").value = clientId || "";
      } catch (e) {
        log("Ошибка при получении logout_request_data:");
        log(e.toString());
        document.getElementById("mainContent").classList.add("hidden");
        document.getElementById("fallbackMessage").classList.remove("hidden");
      }
    }

    function redirectWithHostRewrite(originalUrl) {
      const correctedPath = originalUrl.replace("http://localhost:4444/", "");

      const currentHost = window.location.hostname;
      let baseUrl;
      log("currentHost:");
      log("currentHost: [" + currentHost + "]");
      if (currentHost === "192.168.88.5") {
        baseUrl = "http://192.168.88.5:3001/";
      } else if (currentHost === "logbox.myddns.me") {
        baseUrl = "http://logbox.myddns.me:3001/";
      } else {
        baseUrl = "http://localhost:4444/";
      }

      const finalUrl = baseUrl + correctedPath;
      log("Redirecting to: " + finalUrl);
      window.location.href = finalUrl;
    }

    document.addEventListener('DOMContentLoaded', () => {
      log("=== Logout Flow Ready ===");

      const params = new URLSearchParams(window.location.search);
      const challenge = params.get("logout_challenge");

      if (!challenge) {
        log("Ошибка: отсутствует logout_challenge в URL");
        document.getElementById('logoutBtn').disabled = true;
        document.getElementById("mainContent").classList.add("hidden");
        document.getElementById("fallbackMessage").classList.remove("hidden");
        return;
      }

      document.getElementById('challenge').value = challenge;
      fetchAndDisplayLogoutRequest(challenge);

      document.getElementById('logoutForm').addEventListener('submit', async e => {
        e.preventDefault();
        log("=== Logout Flow Started ===");

        const revokeClient = document.getElementById('revokeClient').checked;
        const revokeAll = document.getElementById('revokeAll').checked;
        const subject = document.getElementById('subject').value;
        const clientId = document.getElementById('clientId').value;
        const challenge = document.getElementById('challenge').value;
        const url = `/logout_process?logout_challenge=${encodeURIComponent(challenge)}`;

        let payload = null;
        if (revokeAll) {
          payload = { subject };
        } else if (revokeClient) {
          payload = { subject, client_id: clientId };
        }

        try {
          let response;
          if (payload) {
            log("Запрос к API с телом: " + JSON.stringify(payload));
            response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          } else {
            log("Запрос к API без удаления токенов.");
            response = await fetch(url, { method: "POST" });
          }

          log("Ответ получен, статус: " + response.status);
          const data = await response.json();
          log("JSON ответ: " + JSON.stringify(data));

          if (data.redirect_to) {
            log("Редирект на: " + data.redirect_to);
            redirectWithHostRewrite(data.redirect_to);
          } else {
            log("Ошибка: redirect_to отсутствует в ответе API.");
          }
        } catch (e) {
          log("Исключение при запросе к /logout_process:");
          log(e.toString());
        }
      });
    });
  </script>
</body>
</html>