<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Завершение сессии</title>
    <style>
        :root {
          --bg-gradient: linear-gradient(145deg, #f0f4f8, #ffffff);
          --text-color: #2c3e50;
          --accent-color: #007bff;
          --accent-hover: #0056b3;
          --border-color: #e0e6ed;
          --code-bg: #f0f0f0;
          --success-bg: #f5fff5;
          --success-border: #28a745;
        }

        * {
          box-sizing: border-box;
        }

        html, body {
          margin: 0;
          padding: 0;
          font-family: "Segoe UI", Roboto, sans-serif;
          background: var(--bg-gradient);
          color: var(--text-color);
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: flex-start;
        }

        .container {
          background: white;
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 2rem 1.5rem;
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
          width: 100%;
          max-width: 720px;
          margin-top: 3vh;
        }

        h2 {
          font-size: 1.4rem;
          margin-bottom: 1rem;
          text-align: center;
        }

        .checkbox-row {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-top: 1rem;
          font-size: 1rem;
          line-height: 1.4;
        }

        .checkbox-row input[type="checkbox"] {
          width: 1.1rem;
          height: 1.1rem;
          accent-color: var(--accent-color);
          margin: 0;
        }

        button {
          margin-top: 1.5rem;
          padding: 0.75rem 1.5rem;
          background-color: var(--accent-color);
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 1rem;
          width: 100%;
          transition: background 0.2s;
        }

        button:hover {
          background-color: var(--accent-hover);
        }

        details {
          margin-top: 1.5rem;
        }

        details pre {
          margin-top: 0.5rem;
          white-space: pre-wrap;
          word-break: break-word;
          background: var(--code-bg);
          padding: 1em;
          border-radius: 5px;
          max-height: 300px;
          overflow: auto;
          font-size: 0.85em;
        }

        #log {
          margin-top: 2rem;
          white-space: pre-wrap;
          border: 1px solid #ccc;
          padding: 1rem;
          background: #fff;
          font-size: 0.9rem;
          border-radius: 8px;
        }

        #fallbackMessage {
          padding: 2rem;
          background: #fff0f0;
          border: 1px solid #f99;
          border-radius: 8px;
          margin-top: 3vh;
          max-width: 600px;
          text-align: center;
        }

        #fallbackMessage p {
          margin-bottom: 1em;
        }

        .hidden {
          display: none;
        }

        @media (max-width: 600px) {
          html, body {
            padding: 1rem;
          }

          h2 {
            font-size: 1.2rem;
          }

          .checkbox-row {
            font-size: 0.95rem;
            flex-direction: row;
            align-items: center;
          }

          button {
            font-size: 1rem;
            padding: 0.75rem 1.2rem;
          }

          details pre {
            font-size: 0.8rem;
          }
        }

    </style>
</head>
<body>
<div class="container" id="mainContent">
    <h2 id="logoutHeader">Завершение сессии</h2>

    <form id="logoutForm">
        <input id="challenge" name="logout_challenge" type="hidden" value="">
        <input id="subject" name="subject" type="hidden">
        <input id="clientId" name="client_id" type="hidden">

        <div class="checkbox-row">
            <input id="revokeClient" type="checkbox">
            <label for="revokeClient" id="revokeClientLabel">Отозвать токены у витрины</label>
        </div>

        <div class="checkbox-row">
            <input id="revokeAll" type="checkbox">
            <label for="revokeAll">Отозвать токены у всех витрин</label>
        </div>
        <button id="logoutBtn" type="submit">Выйти</button>

        <details>
            <summary>Детали get logoutChallenge (техническое)</summary>
            <pre id="logoutRequestJson"></pre>
        </details>

        <div id="log">[Журнал выполнения]\n</div>
    </form>
</div>

<!-- Fallback при ошибке -->
<div class="hidden" id="fallbackMessage">
    <h2>Что-то пошло не так</h2>
    <p>Вы попали на эту страницу при попытке выхода из витрины.</p>
    <p>Однако мы не смогли получить технические данные для завершения выхода.</p>
    <p>Возможно, вы попали сюда напрямую или сессия уже завершена.</p>
    <p>Вы можете закрыть эту вкладку или вернуться на сайт вручную.</p>
</div>

<script>
    function log(msg) {
      console.log(msg);
      document.getElementById('log').textContent += msg + '\n';
    }

    async function fetchAndDisplayLogoutRequest(challenge) {
      try {
        const res = await fetch(`/logout_request_data?logout_challenge=${challenge}`);
        const data = await res.json();
        const logoutRequest = data.logout_request_data;

        document.getElementById("logoutRequestJson").textContent = JSON.stringify(logoutRequest, null, 2);
        log("Данные logout_request загружены и отображены.");

        const sid = logoutRequest.sid;
        const subject = logoutRequest.subject;
        const clientId = logoutRequest.client?.client_id;
        const clientName = logoutRequest.client?.client_name || "неизвестная витрина";

        document.getElementById("logoutHeader").textContent = `Завершение сессии — SID: ${sid}`;
        document.getElementById("revokeClientLabel").innerText = `Отозвать токены у витрины: ${clientName}`;
        document.getElementById("subject").value = subject;
        document.getElementById("clientId").value = clientId || "";
      } catch (e) {
        log("Ошибка при получении logout_request_data:");
        log(e.toString());
        document.getElementById("mainContent").classList.add("hidden");
        document.getElementById("fallbackMessage").classList.remove("hidden");
      }
    }

  function redirectWithHostRewrite(originalUrl) {
    const correctedPath = originalUrl.replace("http://localhost:4444/", "");

    const currentHost = window.location.hostname;
    let baseUrl;
    log("currentHost:");
    log("currentHost: [" + currentHost + "]");
    if (currentHost === "192.168.88.5") {
      baseUrl = "http://192.168.88.5:3001/";
    } else if (currentHost === "logbox.myddns.me") {
      baseUrl = "http://logbox.myddns.me:3001/";
    } else {
      baseUrl = "http://localhost:4444/";
    }

    const finalUrl = baseUrl + correctedPath;
     log("Redirecting to: " + finalUrl);
    window.location.href = finalUrl;
  }


    document.addEventListener('DOMContentLoaded', () => {
      log("=== Logout Flow Ready ===");

      const params = new URLSearchParams(window.location.search);
      const challenge = params.get("logout_challenge");

      if (!challenge) {
        log("Ошибка: отсутствует logout_challenge в URL");
        document.getElementById('logoutBtn').disabled = true;
        document.getElementById("mainContent").classList.add("hidden");
        document.getElementById("fallbackMessage").classList.remove("hidden");
        return;
      }

      document.getElementById('challenge').value = challenge;
      fetchAndDisplayLogoutRequest(challenge);

      document.getElementById('logoutForm').addEventListener('submit', async e => {
        e.preventDefault();
        log("=== Logout Flow Started ===");

        const revokeClient = document.getElementById('revokeClient').checked;
        const revokeAll = document.getElementById('revokeAll').checked;
        const subject = document.getElementById('subject').value;
        const clientId = document.getElementById('clientId').value;
        const challenge = document.getElementById('challenge').value;
        const url = `/logout_process?logout_challenge=${encodeURIComponent(challenge)}`;

        let payload = null;
        if (revokeAll) {
          payload = { subject };
        } else if (revokeClient) {
          payload = { subject, client_id: clientId };
        }

        try {
          let response;
          if (payload) {
            log("Запрос к API с телом: " + JSON.stringify(payload));
            response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          } else {
            log("Запрос к API без удаления токенов.");
            response = await fetch(url, { method: "POST" });
          }

          log("Ответ получен, статус: " + response.status);
          const data = await response.json();
          log("JSON ответ: " + JSON.stringify(data));

          if (data.redirect_to) {
            log("Редирект на: " + data.redirect_to);
            redirectWithHostRewrite(data.redirect_to);
          } else {
            log("Ошибка: redirect_to отсутствует в ответе API.");
          }
        } catch (e) {
          log("Исключение при запросе к /logout_process:");
          log(e.toString());
        }
      });
    });
</script>
</body>
</html>
