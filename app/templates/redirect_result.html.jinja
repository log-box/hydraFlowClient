<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Результат авторизации</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(145deg, #f0f4f8, #ffffff);
      color: #2c3e50;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 2rem;
      background: #fff;
      padding: 2rem 1rem;
      border: 1px solid #e0e6ed;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
      width: 100%;
    }

    h2, h3 {
      text-align: center;
    }

    pre {
      background: #f0f0f0;
      padding: 1em;
      border-radius: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.95rem;
    }

    .token-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .token-blocks {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .token-section {
      flex: 1;
      min-width: 250px;
    }

    .token-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .status.success {
      color: #28a745;
    }

    .status.fail {
      color: #dc3545;
    }

    button.copy {
      margin-top: 0.5rem;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    form {
      margin-top: 2rem;
    }

    form select,
    form input[type="text"] {
      width: 100%;
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    form button[type="submit"] {
      margin-top: 1rem;
      padding: 0.75rem 1.2rem;
      font-size: 1rem;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    form button:hover {
      background-color: #0056b3;
    }

    form label {
      font-weight: 500;
      margin-top: 1rem;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ответ от Hydra</h2>
    <pre>{{ token_data }}</pre>

    <div class="token-container">
      <div class="token-blocks">
        <div class="token-section">
          <div class="token-header">
            <h3>ID Token Payload</h3>
            <span class="status {{ 'success' if id_token_validation_status == 'ok' else 'fail' }}">
              {{ '✔ Успешно' if id_token_validation_status == 'ok' else '✖ Ошибка валидации' }}
            </span>
          </div>
          <button class="copy" onclick="copyToClipboard('id_token_raw')">Скопировать</button>
          <pre id="id_token_raw">id_token_payload: {{ id_token_payload }}</pre>
        </div>

        <div class="token-section">
          <div class="token-header">
            <h3>Access Token Payload</h3>
            <span class="status {{ 'success' if access_token_validation_status == 'ok' else 'fail' }}">
              {{ '✔ Успешно' if access_token_validation_status == 'ok' else '✖ Ошибка валидации' }}
            </span>
          </div>
          <button class="copy" onclick="copyToClipboard('access_token_raw')">Скопировать</button>
          <pre id="access_token_raw">{{ access_token_payload }}</pre>
        </div>

        <div class="token-section">
          <div class="token-header">
            <h3>Refresh Token</h3>
          </div>
          <button class="copy" onclick="copyToClipboard('refresh_token')">Скопировать</button>
          <pre id="refresh_token">{{ refresh_token }}</pre>
        </div>
      </div>

      <div>
        <h3>Raw Payload (Base64 decode)</h3>
        <pre>{{ decoded_payload }}</pre>
      </div>

      <form action="{{ logout_url }}" method="get">
        <label>
          post_logout_redirect_uri:
          <select name="post_logout_redirect_uri">
            {% for uri in post_logout_redirect_uris %}
              <option value="{{ uri }}" {% if uri == post_logout_redirect_uri %}selected{% endif %}>
                {{ uri }}
              </option>
            {% endfor %}
          </select>
        </label>

        <input type="hidden" name="id_token_hint" value="{{ id_token_hint }}">

        <label>
          state:
          <input type="text" name="state" value="{{ state }}">
        </label>

        <button type="submit">Выйти!</button>
      </form>
    </div>
  </div>

  <script>
    function copyToClipboard(id) {
      const text = document.getElementById(id).innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert("Скопировано!");
      });
    }
  </script>

  <script>
    function rewriteLogoutAction() {
      const form = document.querySelector('form');
      if (!form || !form.action.includes('localhost:4444')) return;

      const correctedPath = form.action.replace('http://localhost:4444/', '');
      const currentHost = window.location.hostname;
      let baseUrl;

      if (currentHost === "192.168.88.5") {
        baseUrl = "http://192.168.88.5:3001/";
      } else if (currentHost === "logbox.myddns.me") {
        baseUrl = "http://logbox.myddns.me:3001/";
      } else {
        baseUrl = "http://localhost:4444/";
      }
      form.action = baseUrl + correctedPath;
    }
    window.onload = rewriteLogoutAction;
  </script>
</body>
</html>
